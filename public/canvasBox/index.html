<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Canvas animation</title>
  <script src="canvas.js"></script>
  <style media="screen">
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0px;
    }

    html,
    body,
    canvas {
      margin: 0px;
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>
  <script>
    const canvas = document.getElementById("canvas");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const canvasCtx = canvas.getContext("2d");
    let attractivePointX = -1;
    let attractivePointY = -1;

    const drawCircles = (x, y, r, color) => {
      canvasCtx.beginPath();
      canvasCtx.arc(x, y, r, 0, 2 * Math.PI, false);
      canvasCtx.fillStyle = color;
      canvasCtx.fill();
    }

    const drawRectangle = (x, y, w, h, color) => {
      canvasCtx.beginPath();
      canvasCtx.fillStyle = color;
      canvasCtx.fillRect(x, y, w, h);
    }

    const onWALoaded = () => {
      _initDrawing(canvas.width, canvas.height);
    };

    const render = (circleDataLength, circleStructSize, colorStructSize) => {
      const mainColorDatas = new Float32Array(Module.HEAP32.buffer, _getMainColor(), colorStructSize);
      const circlesDatas = new Float32Array(Module.HEAP32.buffer, _getCircles(canvas.width, canvas.height, attractivePointX, attractivePointY), circleDataLength);
      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

      const backgroundColor = `rgba(${mainColorDatas[0]},${mainColorDatas[1]},${mainColorDatas[2]},${mainColorDatas[3]})`;
      drawRectangle(0, 0, canvas.width, canvas.height, backgroundColor);

      drawCircles(attractivePointX, attractivePointY, 5, `blue`);
      for (let i = 0; i < circlesDatas.length; i += circleStructSize) {
        const x = circlesDatas[i];
        const y = circlesDatas[i + 1];
        const r = circlesDatas[i + 2];
        const cr = circlesDatas[i + 3];
        const cb = circlesDatas[i + 4];
        const cg = circlesDatas[i + 5];
        const ca = circlesDatas[i + 6];
        drawCircles(x, y, r, `rgba(${cr},${cg},${cb},${ca})`);
      }

      window.requestAnimationFrame(() => {
        render(circleDataLength, circleStructSize, colorStructSize);
      });
    }

    canvas.onmousemove = e => {
      // if (attractivePointX !== e.clientX) {
      //   attractivePointX = e.clientX;
      // } else {
      //   attractivePointX = -1;
      // }


      // if (attractivePointY !== e.clientY) {
      //   attractivePointY = e.clientY;
      // } else {
      //   attractivePointY = -1;
      // }

      attractivePointX = e.clientX;
      attractivePointY = e.clientY;
    };

    canvas.onmouseout = () => {
      attractivePointX = -1;
      attractivePointY = -1;
    };
  </script>
</body>

</html>